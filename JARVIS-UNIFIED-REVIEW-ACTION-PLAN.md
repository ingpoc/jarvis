# Jarvis v2.0 - Unified Review Action Plan

**Generated by:** Expert Review Team (jarvis-code-review)
**Date:** 2026-02-11
**Review Scope:** Jarvis macOS App + PRD v2.0 + improvements.md

---

## Executive Summary

| Metric | Value |
|--------|-------|
| **PRD Completeness** | 25% (down from 30% after deep review) |
| **Architecture Compliance** | 6.5/10 |
| **Code Quality Grade** | B+ (75/100) |
| **Critical P0 Issues** | 13 |
| **High P1 Issues** | 15 |
| **Total Issues Identified** | 57+ |

---

## üî¥ P0 Issues - Fix Immediately

### 1. PersistenceManager Logic Bug

**File:** `PersistenceManager.swift:212`
**Expert:** Python SDK
**Effort:** 5 minutes

```swift
// BAD (current)
guard !events.isEmpty && !containers.isEmpty else { return }

// GOOD
guard !events.isEmpty || !containers.isEmpty else { return }
```

**Impact:** Fresh installs never load data - app appears empty on first launch.

---

### 2. SQLite Connection Leaks

**File:** All Python files using SQLite (`memory.py`, `budget.py`, `trust.py`)
**Expert:** Python SDK
**Effort:** 2 hours

**Issue:** Every query creates new connection. Will exhaust file descriptors under load.

**Fix:** Implement connection pooling

```python
# Add to memory.py
import threading
from queue import Queue

class ConnectionPool:
    def __init__(self, db_path, max_connections=5):
        self.db_path = db_path
        self.pool = Queue(max_connections)
        self.local = threading.local()
        for _ in range(max_connections):
            self.pool.put(sqlite3.connect(db_path, check_same_thread=False))

    def get_connection(self):
        if not hasattr(self.local, 'conn'):
            self.local.conn = self.pool.get()
        return self.local.conn

    def return_connection(self):
        if hasattr(self.local, 'conn'):
            self.pool.put(self.local.conn)
            del self.local.conn
```

---

### 3. Budget Enforcement Race Condition

**File:** `agents.py:249-256`
**Expert:** Python SDK
**Effort:** 1 hour

**Issue:** Check-then-act race. Multiple concurrent tasks can bypass budget.

**Fix:** Use atomic SQLite transaction for check-and-decrement

```python
def enforce_and_record(self, estimated_cost: float) -> tuple[bool, str]:
    with self._lock:
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("BEGIN IMMEDIATE")
        cursor.execute("SELECT remaining FROM budget WHERE id = 1")
        remaining = cursor.fetchone()[0]
        if remaining < estimated_cost:
            conn.rollback()
            return False, "Insufficient budget"
        cursor.execute("UPDATE budget SET remaining = remaining - ?", (estimated_cost,))
        conn.commit()
        return True, "OK"
```

---

### 4. Error Pattern Auto-Capture Missing

**File:** `orchestrator.py:285-336`
**Expert:** PRD Strategy
**Effort:** 2 hours

**Issue:** `_post_tool_hook` exists but never calls `learn_pattern()`. Core PRD promise "Never debug same error twice" is NOT delivered.

**Fix:** Add pattern detection in `_post_tool_hook`

```python
def _post_tool_hook(self, tool_name: str, input_data: dict, result: dict):
    # Detect: error ‚Üí fixing command ‚Üí success
    if tool_name == "Bash" and result.get("exit_code") != 0:
        error_pattern = self._extract_error_pattern(input_data, result)
        self._store_pending_error(error_pattern, input_data)
    elif self._is_fixing_command(input_data) and self._has_pending_error():
        self._learn_fix_pattern(self._get_pending_error(), input_data)
```

---

### 5. Bootstrap Skill System Missing

**File:** Project root
**Expert:** PRD Strategy
**Effort:** 4 hours

**Issue:** No `.jarvis/bootstrap/` directory exists. First-week experience will be WORSE than Claude Code.

**Fix:**

1. Create `~/.jarvis/bootstrap/skills/` with 15 pre-written skills
2. Add `copy_bootstrap_skills()` in orchestrator initialization
3. Required skills: git-workflow, test-setup, error-classification, dockerfile-generation, commit-message, api-endpoint-scaffold

---

### 6. Activity State Machine Not Integrated

**File:** `harness.py` + `JarvisStatus.swift`
**Expert:** Architecture
**Effort:** 3 hours

**Issue:** BuildHarness (feature states: START/INIT/IMPLEMENT/TEST/COMPLETE) not integrated with JarvisStatus (activity states: idle/building/testing). System cannot auto-hibernate.

**Fix:** Create state bridge in orchestrator

```python
class ActivityStateMachine:
    def __init__(self):
        self.last_activity = time.time()
        self.state = JarvisStatus.idle

    def record_activity(self):
        self.last_activity = time.time()
        if self.state != JarvisStatus.building:
            self.transition_to(JarvisStatus.building)

    def check_idle(self, timeout_seconds=600):
        if time.time() - self.last_activity > timeout_seconds:
            self.transition_to(JarvisStatus.idle)
```

---

### 7. Three-Tier Model Routing Not Implemented

**File:** `config.py` + new `router.py`
**Expert:** Architecture / PRD Strategy
**Effort:** 4 hours

**Issue:** PRD specifies Qwen3 4B (local), GLM 4.7 (API), Apple FM. Only GLM 4.7 exists.

**Recommendation:** Simplify PRD - remove MLX/FM from v2.0 scope. Implement basic routing:

```python
class ModelRouter:
    def route(self, task_type: str, complexity: str) -> str:
        if task_type in ["autocomplete", "error_triage"]:
            return "local"  # Future Qwen3
        elif complexity == "high":
            return "claude-opus-4-6"
        else:
            return "claude-sonnet-4-5"
```

---

### 8. Hardcoded WebSocket URL with Fatal Crash

**File:** `WebSocketClient.swift:137-139`
**Expert:** Python SDK / improvements.md
**Effort:** 30 minutes

```swift
// BAD (current)
guard let url = URL(string: "ws://127.0.0.1:9847") else {
    fatalError("Invalid WebSocket URL configuration: ws://127.0.0.1:9847")
}

// GOOD
private let url: URL
init(serverURL: String = "ws://127.0.0.1:9847") {
    guard let url = URL(string: serverURL) else {
        self.url = URL(string: "ws://127.0.0.1:9847")!  // Fallback
        logger.error("Invalid WebSocket URL, using fallback")
        return
    }
    self.url = url
}
```

---

### 9. Apple Containerization is Fake

**File:** `container_tools.py`
**Expert:** Architecture
**Effort:** 8 hours OR 30 min for doc update

**Issue:** Code wraps `container` CLI that doesn't exist on macOS.

**Options:**

1. **Implement real Apple Virtualization Framework** (8 hours)
2. **Switch to Docker** (2 hours)
3. **Document as TODO** and remove from v2.0 promises (30 min)

---

### 10. Confidence Threshold Boundary Bug

**File:** `decision_tracer.py:217`
**Expert:** Architecture
**Effort:** 5 minutes

```python
# BAD (current)
if best.confidence > 0.75:      # Exactly 0.75 falls through!

# GOOD
if best.confidence >= 0.75:     # Include 0.75
```

---

### 11. PendingRequest Memory Leak (CRITICAL - NEW)

**File:** `WebSocketClient.swift:248-259`
**Expert:** Code Quality
**Effort:** 15 minutes

**Issue:** When timeout Task executes, callbacks aren't canceled. Double execution possible.

**Fix:** Store Task reference and cancel on successful response.

---

### 12. WebSocketClient Thread Safety Violation (CRITICAL - NEW)

**File:** `WebSocketClient.swift` (entire class)
**Expert:** Code Quality
**Effort:** 10 minutes

**Issue:** `@Observable` but NOT `@MainActor`. Properties modified from background DispatchQueue.

**Fix:** Add `@MainActor` annotation or ensure ALL mutations via `DispatchQueue.main.async`.

---

### 13. Spotlight Integration Broken (CRITICAL - NEW)

**File:** `SpotlightService.swift:240-260`, `AppDelegate.swift:25-26`
**Expert:** Code Quality
**Effort:** 30 minutes

**Issue:** Spotlight items indexed but `handleSelectedItem()` never called. Tapping search results does nothing.

**Fix:** Implement the handler in AppDelegate.

---

## üü° P1 Issues - High Priority

### 14. Fourth Event Type Switch Statement Found (NEW)

### 11. Container Cleanup No SIGKILL Handler

**File:** `agents.py:469-471`
**Expert:** Python SDK
**Effort:** 30 minutes

```python
import atexit
import signal

def register_cleanup_handlers(self):
    atexit.register(self._cleanup_containers)
    signal.signal(signal.SIGTERM, self._signal_handler)
    signal.signal(signal.SIGINT, self._signal_handler)
```

---

### 12. Spotlight Indexing Rate Limiting

**File:** `SpotlightService.swift:42-48`
**Expert:** Python SDK
**Effort:** 30 minutes

```swift
private var indexingDebouncer = Debouncer(delay: 0.5)

func indexEvent(_ event: TimelineEvent) {
    indexingDebouncer.debounce {
        CSSearchableIndex.default().indexSearchableItems([item]) { error in ... }
    }
}
```

---

### 13. MCP Response Truncation Indicator

**File:** All MCP tools (`container_tools.py:155`, `git_tools.py:93`)
**Expert:** Python SDK
**Effort:** 30 minutes

```python
"stdout": result["stdout"][:10000],
"truncated": len(result["stdout"]) > 10000,  # Add this
```

---

### 14. Inconsistent Environment Access Patterns

**File:** Multiple Swift files
**Expert:** Code Quality
**Effort:** 1 hour

Standardize on `@Environment(WebSocketClient.self)` for Swift 6:

- `JarvisMenuView.swift:25`
- `QuickActionsView.swift:7`
- `StatusBadge.swift:4`
- `TimelineView.swift:4`
- `CommandCenterView.swift:10`
- `ApprovalView.swift:4`

---

### 15. Magic Numbers Should Be Constants

**File:** Multiple files
**Expert:** Code Quality
**Effort:** 1 hour

Create `Configuration.swift`:

```swift
enum WebSocketDefaults {
    static let port = 9847
    static let defaultTimeout: TimeInterval = 30.0
    static let maxEvents = 200
    static let maxPendingApprovals = 50
}
```

---

### 16. EventType Enum Missing

**File:** Multiple Swift files
**Expert:** Code Quality
**Effort:** 2 hours

```swift
enum EventType: String {
    case toolUse = "tool_use"
    case approvalNeeded = "approval_needed"
    // ... all cases

    var icon: String { ... }
    var color: Color { ... }
}
```

---

### 17. Decision Trace Silent Failures

**File:** `decision_tracer.py:96`
**Expert:** PRD Strategy
**Effort:** 30 minutes

```python
except Exception as e:
    logger.warning("MCP query failed: {e}")  # Was debug, should be warning
    # Fail fast instead of silent fallback
```

---

### 18. Duplicate QuickActions Code

**File:** `QuickActionsView.swift:62-80` and `QuickActionsGrid.swift:118-136`
**Expert:** Code Quality
**Effort:** 1 hour

Extract to shared utility `QuickActionsHandler`.

---

### 19. Voice Integration Not Documented in PRD

**File:** `voice.py`, `config.py:62-70`
**Expert:** PRD Strategy
**Effort:** 30 minutes

ADD to PRD G7 Mac-Native Performance: "Voice feedback for critical events"

---

### 20. Slack Bot Not Documented in PRD

**File:** `slack_bot.py`
**Expert:** PRD Strategy
**Effort:** 30 minutes

ADD to PRD G5 Multi-Domain: "Remote approval channel via Slack"

---

### 21. Git Sensitive File Blocking Insufficient

**File:** `git_tools.py:141-143`
**Expert:** Python SDK
**Effort:** 30 minutes

Expand blocklist: `.key`, `.p12`, `.cert`, `token`, `auth`, `credentials.json`, `service-account.json`

---

### 22. Fourth Event Type Switch Statement (NEW)

**File:** `SpotlightService.swift:163-184`
**Expert:** Code Quality
**Effort:** Part of EventType enum (Issue #16)

**Issue:** Fourth location with event type switch found (along with TimelineView, ViewExtensions, TimelineViewModel).

---

### 23. Hardcoded Reconnect Delay (NEW)

**File:** `WebSocketClient.swift:427`
**Expert:** Code Quality
**Effort:** 5 minutes

```swift
// BAD
DispatchQueue.main.asyncAfter(deadline: .now() + 5, execute: work)

// GOOD
DispatchQueue.main.asyncAfter(deadline: .now() + WebSocketDefaults.reconnectDelay, execute: work)
```

---

### 24. Hotkey Magic Number (NEW)

**File:** `MenuBarManager.swift:69`
**Expert:** Code Quality
**Effort:** 15 minutes

```swift
// BAD - what is keyCode 38?
if event.modifierFlags.contains([.command, .shift]) && event.keyCode == 38 {

// GOOD
enum HotKey: UInt16 { case j = 38 }  // Document: Cmd+Shift+J
if event.modifierFlags.contains([.command, .shift]) && event.keyCode == HotKey.j.rawValue {
```

---

## üîµ P2 Issues - Medium Priority

### 22. Trust Tier Re-Escalation Cooldown

**File:** `trust.py:167-174`
**Expert:** Python SDK
**Effort:** 1 hour

Require 20 consecutive successes after rollback before re-escalation.

---

### 23. Loop Detection Threshold Too Aggressive

**File:** `loop_detector.py:142-143`
**Expert:** Python SDK
**Effort:** 15 minutes

Increase from 3 to 5 errors; check for transient errors (429, 503).

---

### 24. MCP Server Health Validation

**File:** `agents.py:229-236`
**Expert:** Python SDK
**Effort:** 2 hours

Add `health_check()` method to each MCP server.

---

### 25. No Loading States in UI

**File:** `CommandCenterView.swift:37-45`
**Expert:** improvements.md
**Effort:** 1 hour

Add `@State private var isRefreshing` with disabled button state.

---

### 26. Missing Accessibility Labels

**File:** `CommandCenterView.swift:74-76`
**Expert:** improvements.md
**Effort:** 1 hour

Replace color-only status circles with icons.

---

### 27. Inconsistent Color Mapping

**File:** `TimelineView.swift:41-50` vs `CommandCenterView.swift:155-162`
**Expert:** improvements.md
**Effort:** 1 hour

Create shared `EventColors` utility.

---

### 28. WebSocket Send Errors Logged

**File:** `WebSocketClient.swift:44`
**Expert:** improvements.md
**Effort:** 30 minutes

Already fixed - errors are now logged at line 240-245.

---

## üìä Summary by Category

| Category | P0 | P1 | P2 | Total |
|----------|----|----|----|----|
| **Critical Bugs** | 8 | 4 | 0 | 12 |
| **PRD Gaps** | 3 | 2 | 0 | 5 |
| **Architecture** | 2 | 1 | 2 | 5 |
| **Code Quality** | 0 | 8 | 4 | 12 |
| **UI/UX** | 0 | 0 | 3 | 3 |
| **Documentation** | 0 | 2 | 0 | 2 |

---

## üéØ Implementation Order Recommendation

### Week 1: Critical Bugs (P0)

1. PersistenceManager logic bug (5 min) - Issue #1
2. Confidence threshold bug (5 min) - Issue #10
3. WebSocket URL config (30 min) - Issue #8
4. Budget enforcement race condition (1 hour) - Issue #3
5. SQLite connection pooling (2 hours) - Issue #2
6. MCP truncation indicator (30 min) - Issue #13 (moved)
7. SIGKILL handler (30 min) - Issue #11 (moved)
8. **PendingRequest memory leak** (15 min) - Issue #11 NEW
9. **WebSocketClient @MainActor** (10 min) - Issue #12 NEW
10. **Spotlight handleSelectedItem** (30 min) - Issue #13 NEW

### Week 2: PRD Foundation (P0)

1. Error pattern auto-capture (2 hours)
2. Bootstrap skill system (4 hours)
3. Activity state machine (3 hours)
4. Three-tier routing or PRD update (4 hours)

### Week 3: Code Quality (P1)

1. Environment access standardization (1 hour)
2. Magic constants extraction (1 hour)
3. EventType enum (2 hours)
4. Duplicate code extraction (1 hour)
5. Spotlight rate limiting (30 min)

### Week 4: Polish (P1-P2)

1. UI loading states (1 hour)
2. Accessibility labels (1 hour)
3. Color mapping utility (1 hour)
4. MCP health validation (2 hours)
5. Documentation updates (1 hour)

---

## üìù PRD Revision Recommendations

### REMOVE from v2.0 Scope

- G4: Three-Tier Intelligence (simplify to single model routing)
- G2: Autonomous Skill Creation (defer to v2.3)
- Apple Foundation Models (mark as exploratory)

### ADD to v2.0 Scope

- Bootstrap skill kit (15 skills minimum)
- Error pattern auto-capture hooks
- Voice + Slack documentation

### RE-PRIORITIZE

- G1 (Persistent Learning): Raise to P0
- G6 (Day-One Usefulness): Raise to P0
- G8 (Self-Extension): Lower to P2

---

## üìà Success Metrics

| Metric | Current | Target | Timeline |
|--------|---------|--------|----------|
| PRD Completeness | 25% | 65% | 8 weeks |
| Architecture Score | 6.5/10 | 8.5/10 | 4 weeks |
| Code Quality Grade | B+ (75) | A- (90) | 6 weeks |
| P0 Bugs | 10 | 0 | 2 weeks |
| Test Coverage | ~30% | 80% | 8 weeks |

---

**Report End**

Generated by expert review team: jarvis-code-review
Swift/macOS expert report not received (4 of 5 reports used)
